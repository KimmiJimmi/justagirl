<link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&display=swap" rel="stylesheet">
<style>
    :root { --main-bg: #1a1a1a; --accent: #D47996; }
    
    .pfp-container {
        background: var(--main-bg);
        padding: 20px;
        border-radius: 12px;
        font-family: 'Dela Gothic One', cursive;
        color: white;
        text-align: center;
        width: 100%;
        box-sizing: border-box;
    }
    .pfp-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }
    .file-input-label {
        background: white; color: black; padding: 8px 12px;
        border-radius: 4px; font-size: 11px; cursor: pointer;
    }
    .control-item { display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 80px; }
    .control-item span { font-size: 10px; margin-bottom: 4px; }
    
    input[type="range"] { 
        width: 100%; 
        cursor: pointer; 
        accent-color: #ffffff; 
    }
    
    button {
        font-family: 'Dela Gothic One', cursive;
        padding: 8px 14px; border: none; border-radius: 4px;
        cursor: pointer; font-size: 11px; transition: 0.2s;
    }
    .btn-reset { background: white; color: black; }
    .btn-download { background: var(--accent); color: white; }
    .btn-download:hover { background: #D47996; }

    .pfp-hint { font-size: 11px; color: #888; margin-bottom: 15px; font-family: sans-serif; }
    
    .canvas-area { background: #000; line-height: 0; border: 1px solid #333; position: relative; }
    canvas { 
        max-width: 100%; 
        height: auto; 
        cursor: grab; 
        background-color: #000; 
        touch-action: none; /* Prevents mobile scrolling while dragging */
    }
    canvas:active { cursor: grabbing; }
</style>

<div class="pfp-container">
    <div class="pfp-header">
        <label class="file-input-label">
            CHOOSE FILE
            <input type="file" id="upload" accept="image/*" style="display:none" />
        </label>
        <div class="control-item">
            <span>ZOOM</span>
            <input type="range" id="zoom" min="0.1" max="1.5" step="0.01" value="0.5">
        </div>
        <div class="control-item">
            <span>ROTATE</span>
            <input type="range" id="rotate" min="-180" max="180" step="1" value="0">
        </div>
        <button id="reset" class="btn-reset">RESET</button>
        <button id="download" class="btn-download">DOWNLOAD</button>
    </div>

    <div class="pfp-hint">1. Upload → 2. Drag Bow → 3. Scale & Rotate → 4. Download PFP!</div>

    <div class="canvas-area">
        <canvas id="canvas" width="512" height="512"></canvas>
    </div>
</div>

<script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const upload = document.getElementById("upload");
    const downloadBtn = document.getElementById("download");
    const zoomSlider = document.getElementById("zoom");
    const rotateSlider = document.getElementById("rotate");
    const resetBtn = document.getElementById("reset");

    const hatOverlay = new Image();
    hatOverlay.crossOrigin = "anonymous"; 
    hatOverlay.src = "https://raw.githubusercontent.com/KimmiJimmi/justagirl/main/bow.PNG"; 

    let userImage = null;
    let hatScale = 0.5, hatRotation = 0, hatX = 256, hatY = 200;
    let isDragging = false, lastX = 0, lastY = 0;

    function draw() {
        ctx.fillStyle = "#000000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (userImage) {
            const ratio = Math.max(canvas.width / userImage.width, canvas.height / userImage.height);
            const x = (canvas.width - userImage.width * ratio) / 2;
            const y = (canvas.height - userImage.height * ratio) / 2;
            ctx.drawImage(userImage, x, y, userImage.width * ratio, userImage.height * ratio);
        } else {
            ctx.fillStyle = "#444";
            ctx.textAlign = "center";
            ctx.font = "14px Arial";
            ctx.fillText("Upload photo to start", 256, 256);
        }

        if (hatOverlay.complete) {
            const w = hatOverlay.width * hatScale, h = hatOverlay.height * hatScale;
            ctx.save();
            ctx.translate(hatX, hatY);
            ctx.rotate((hatRotation * Math.PI) / 180);
            ctx.drawImage(hatOverlay, -w / 2, -h / 2, w, h);
            ctx.restore();
        }
    }

    upload.onchange = (e) => {
        if (!e.target.files[0]) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            userImage = new Image();
            userImage.onload = draw;
            userImage.src = ev.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    zoomSlider.oninput = (e) => { hatScale = parseFloat(e.target.value); draw(); };
    rotateSlider.oninput = (e) => { hatRotation = parseInt(e.target.value); draw(); };
    
    resetBtn.onclick = () => { 
        hatScale = 0.5; hatRotation = 0; hatX = 256; hatY = 200; 
        zoomSlider.value = 0.5; rotateSlider.value = 0; 
        draw(); 
    };

    // Corrected coordinate logic for mobile/desktop
    const getCoords = (e) => {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        // Scale factor: internal canvas size / CSS display size
        return {
            x: (clientX - rect.left) * (canvas.width / rect.width),
            y: (clientY - rect.top) * (canvas.height / rect.height)
        };
    };

    const startDrag = (e) => {
        isDragging = true;
        const coords = getCoords(e);
        lastX = coords.x;
        lastY = coords.y;
    };

    const moveDrag = (e) => { 
        if (!isDragging) return;
        const coords = getCoords(e);
        hatX += coords.x - lastX; 
        hatY += coords.y - lastY; 
        lastX = coords.x; 
        lastY = coords.y; 
        draw(); 
    };

    const stopDrag = () => { isDragging = false; };

    // Unified Event Listeners
    canvas.addEventListener('mousedown', startDrag);
    window.addEventListener('mousemove', moveDrag);
    window.addEventListener('mouseup', stopDrag);

    canvas.addEventListener('touchstart', (e) => { startDrag(e); e.preventDefault(); }, {passive: false});
    window.addEventListener('touchmove', (e) => { moveDrag(e); }, {passive: false});
    window.addEventListener('touchend', stopDrag);

    downloadBtn.onclick = () => {
        if (!userImage) return alert("Please upload an image first.");
        const link = document.createElement("a");
        link.download = "girl-pfp.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
    };

    hatOverlay.onload = draw;
</script>